# 支付系统核心 API 架构设计文档

## 1. 架构概述

本项目采用分层架构设计，遵循 SOLID 原则，确保代码的可维护性、可扩展性和高性能。

### 1.1 架构特点

- **分层清晰**: Controller → Service → Model → Database
- **高并发支持**: 使用 Gin 框架 + 连接池 + Redis 缓存
- **工程化**: 统一的错误处理、日志、配置管理
- **易于扩展**: 模块化设计，便于添加新功能

## 2. 项目结构

```
golang-pay-core/
├── config/              # 配置管理
│   ├── config.yaml     # 配置文件
│   └── config.go       # 配置结构定义
├── internal/           # 内部代码（不对外暴露）
│   ├── controller/     # 控制器层（处理 HTTP 请求）
│   ├── service/        # 业务逻辑层
│   ├── models/         # 数据模型层
│   ├── database/       # 数据库连接层
│   ├── middleware/     # 中间件
│   ├── router/         # 路由配置
│   ├── response/       # 响应处理
│   └── utils/          # 工具函数
├── sql/                # SQL 文件
├── docs/               # 文档
├── main.go             # 应用入口
└── Makefile            # 构建脚本
```

## 3. 分层设计

### 3.1 Controller 层

**职责**:
- 接收 HTTP 请求
- 参数验证
- 调用 Service 层
- 返回 HTTP 响应

**示例**: `internal/controller/order_controller.go`

### 3.2 Service 层

**职责**:
- 业务逻辑处理
- 事务管理
- 数据校验
- 调用 Model 层

**示例**: `internal/service/order_service.go`

### 3.3 Model 层

**职责**:
- 数据模型定义
- 数据库表映射
- 关联关系定义

**示例**: `internal/models/order.go`

### 3.4 Database 层

**职责**:
- 数据库连接管理
- 连接池配置
- Redis 连接管理

**示例**: `internal/database/mysql.go`, `internal/database/redis.go`

## 4. 核心模块

### 4.1 订单模块

- **创建订单**: 支持创建支付订单，生成唯一订单号
- **查询订单**: 支持根据订单号或商户订单号查询
- **更新订单状态**: 支持订单状态流转（待支付 → 已支付/失败/取消）

### 4.2 商户模块

- **商户验证**: 验证商户是否存在且有效
- **支付通道关联**: 获取商户可用的支付通道列表

### 4.3 支付通道模块

- **通道查询**: 获取可用的支付通道
- **通道验证**: 验证支付通道是否可用（状态、时间、金额范围）

## 5. 中间件

### 5.1 日志中间件

记录所有 HTTP 请求的详细信息：
- 请求方法、路径、参数
- 响应状态码
- 响应时间
- 客户端 IP

### 5.2 跨域中间件

处理 CORS 跨域请求

### 5.3 异常恢复中间件

捕获 panic，防止服务崩溃

## 6. 高并发优化

### 6.1 数据库连接池

```yaml
database:
  max_idle_conns: 10      # 最大空闲连接数
  max_open_conns: 100     # 最大打开连接数
  conn_max_lifetime: 3600s # 连接最大生存时间
```

### 6.2 Redis 缓存

- 缓存热点数据（商户信息、支付通道等）
- 减少数据库查询压力
- 支持分布式锁（可扩展）

### 6.3 异步处理

- 支持异步任务处理（可扩展）
- 订单通知异步发送
- 日志异步写入

## 7. 配置管理

使用 Viper 统一管理配置：

- **环境变量支持**: 可通过环境变量覆盖配置
- **配置文件**: YAML 格式，易于阅读和维护
- **类型安全**: 强类型配置结构

## 8. 日志系统

使用 Zap 高性能日志库：

- **结构化日志**: JSON 格式，便于日志分析
- **日志级别**: Debug、Info、Warn、Error
- **日志轮转**: 支持按大小和时间轮转
- **文件输出**: 支持输出到文件或标准输出

## 9. 错误处理

统一的错误处理机制：

- **响应格式**: 统一的 JSON 响应格式
- **错误码**: 标准 HTTP 状态码
- **错误信息**: 清晰的错误提示

## 10. 安全设计

### 10.1 数据安全

- SQL 注入防护（使用 GORM 参数化查询）
- XSS 防护
- CSRF 防护（可扩展）

## 11. 扩展性设计

### 11.1 插件化支付通道

- 支持多种支付方式（支付宝、微信等）
- 统一的支付接口
- 易于添加新的支付通道

### 11.2 消息队列（可扩展）

- 支持异步任务处理
- 订单通知队列
- 日志队列

### 11.3 监控和告警（可扩展）

- 性能监控
- 错误告警
- 业务指标统计

## 12. 开发规范

### 12.1 命名规范

- **包名**: 小写，简短
- **函数名**: 驼峰命名，首字母大写表示公开
- **变量名**: 驼峰命名，见名知意

### 12.2 代码组织

- 一个文件一个主要功能
- 相关功能放在同一包下
- 避免循环依赖

### 12.3 错误处理

- 所有错误都要处理
- 返回有意义的错误信息
- 使用 `fmt.Errorf` 包装错误

## 13. 部署建议

### 13.1 容器化部署

- 使用 Docker 容器化
- 支持 Kubernetes 部署
- 健康检查端点

### 13.2 负载均衡

- 多实例部署
- 使用 Nginx 或云负载均衡器
- 会话保持（如需要）

### 13.3 数据库

- 主从复制
- 读写分离（可扩展）
- 连接池优化

## 14. 性能优化建议

1. **数据库索引**: 确保常用查询字段有索引
2. **缓存策略**: 合理使用 Redis 缓存
3. **连接池**: 根据实际负载调整连接池大小
4. **异步处理**: 耗时操作异步处理
5. **限流**: 实现 API 限流（可扩展）

## 15. 后续扩展方向

1. **API 文档**: 集成 Swagger/OpenAPI
2. **单元测试**: 添加完整的单元测试
3. **集成测试**: 添加集成测试
4. **性能测试**: 压力测试和性能优化
5. **监控告警**: 集成 Prometheus + Grafana
6. **链路追踪**: 集成 Jaeger 或 Zipkin
7. **消息队列**: 集成 RabbitMQ 或 Kafka
8. **分布式锁**: 实现分布式锁机制

