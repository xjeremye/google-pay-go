# 支付宝类型下单流程与统计数据逻辑梳理

## 一、下单流程概览

支付宝类型下单流程主要分为以下几个阶段：

1. **订单创建阶段** - 验证参数、创建订单
2. **产品选择阶段** - 根据条件选择支付宝产品
3. **支付URL生成阶段** - 调用支付宝SDK生成支付链接
4. **订单提交回调** - 记录下单统计
5. **支付成功回调** - 处理成功订单，更新统计数据
6. **订单成功通知** - 触发各种统计回调

---

## 二、详细流程说明

### 2.1 订单创建阶段

**位置**: `backend/dvadmin/agent_manager/views/order.py` - `OrderViewSet.create()`

**主要步骤**:

1. 验证商户、租户、签名
2. 检查通道配置
3. **计算手续费**（关键步骤）

#### 2.1.1 手续费计算

**位置**: `backend/dvadmin/agent_manager/utils/order/handle.py`

##### 租户手续费计算 (`_order_check_tenant_channel`)

```python
# 文件: backend/dvadmin/agent_manager/utils/order/handle.py:142-156
def _order_check_tenant_channel(ctx: OrderCreateCtx) -> None:
    channel_tax = PayChannelTax.objects.filter(
        pay_channel_id=ctx.channel_id,
        tenant_id=ctx.tenant_id
    ).first()
    
    if channel_tax.tax != 0:
        # 手续费计算公式: 浮动后金额 * 费率 / 100，四舍五入，最低扣除1分
        ctx.tax = max(int(channel_tax.tax * ctx.money / 100 + Decimal(0.5)), 1)
```

**公式**:

```
租户手续费 = max(int(通道费率 * 订单金额(浮动后) / 100 + 0.5), 1)
```

- `通道费率`: `PayChannelTax.tax` (百分比，如 0.5 表示 0.5%)
- `订单金额`: 已应用通道浮动金额后的金额
- `最低扣除`: 1分（即使计算结果为0，也至少扣除1分）

##### 商户手续费计算 (`_order_check_merchant_channel`)

```python
# 文件: backend/dvadmin/agent_manager/utils/order/handle.py:118-139
def _order_check_merchant_channel(ctx: OrderCreateCtx) -> None:
    merchant_channel = MerchantPayChannel.objects.filter(
        merchant_id=ctx.merchant_id,
        pay_channel_id=ctx.channel_id
    ).first()
    
    if merchant_channel.tax != 0:
        # 商户费率,浮动前,四舍五入
        ctx.merchant_tax = int(merchant_channel.tax * ctx.money / 100)
```

**公式**:

```
商户手续费 = int(商户费率 * 订单金额(浮动前) / 100)
```

- `商户费率`: `MerchantPayChannel.tax` (百分比)
- `订单金额`: 原始订单金额（未应用浮动）
- 注意：商户手续费是浮动前计算的，不设最低扣除

**实际收入计算**:

```python
# 文件: backend/dvadmin/agent_manager/utils/util.py:721
real_money = order_obj.detail.notify_money - order_obj.detail.merchant_tax
```

```
实际收入 = 通知金额 - 商户手续费
```

---

### 2.2 产品选择阶段

**位置**: `backend/dvadmin/agent_manager/pay_plugins/alipay_plugin.py` - `get_writeoff_product()`

**主要逻辑**:

1. 根据通道模式选择产品（普通模式/公池模式/神码模式）
2. 检查产品限额、金额范围
3. 检查日成功笔数限制
4. 应用金额浮动（如果配置）

**金额浮动**:

```python
# 文件: backend/dvadmin/agent_manager/pay_plugins/alipay_plugin.py:212-213
if i["float_min_money"] != i["float_max_money"] != 0:
    money += random.randint(i["float_min_money"], i["float_max_money"])
```

---

### 2.3 支付URL生成阶段

**位置**: `backend/dvadmin/agent_manager/pay_plugins/alipay_plugin.py` - `create_order()`

根据不同的支付宝插件类型，调用不同的支付宝SDK方法：

- `alipay_face_to`: 当面付
- `alipay_ddm`: 扫码支付
- `alipay_wap`: 手机网站支付
- `alipay_phone`: 手机支付
- `alipay_pc`: 电脑网站支付
- `alipay_app`: APP支付

---

### 2.4 订单提交回调 (`callback_submit`)

**位置**: `backend/dvadmin/agent_manager/pay_plugins/alipay_plugin.py:281-302`

**触发时机**: 订单创建后，产品选择完成

**统计逻辑**:

```python
def callback_submit(self, product_id, create_datetime, plugin_upstream,
                    order_no, tenant_id, channel_id, money, **kwargs):
    channel = PayChannel.objects.filter(id=channel_id).first()
    
    if channel and channel.extra_arg == 1:  # 公池模式
        pool = AlipayPublicPool.objects.filter(alipay_id=product_id).first()
        if pool:
            submit_base_day_statistics(AlipayPublicPoolDayStatistics,
                                       pool_id=pool.id, 
                                       date=create_datetime.date(),
                                       pay_channel_id=channel_id)
    else:
        if tenant_id != product.writeoff.parent_id:  # 神码模式
            shenma = AlipayShenma.objects.filter(alipay_id=product_id, tenant=tenant_id).first()
            if shenma:
                submit_base_day_statistics(AlipayShenmaDayStatistics,
                                           shenma_id=shenma.id, 
                                           date=create_datetime.date(),
                                           pay_channel_id=channel_id)
        else:  # 普通模式
            submit_base_day_statistics(AlipayProductDayStatistics,
                                       product_id=product_id, 
                                       date=create_datetime.date(),
                                       pay_channel_id=channel_id)
```

**统计内容**:

- 增加 `submit_count`（提交次数）
- 增加 `submit_money`（提交金额）

---

### 2.5 支付成功回调 (`callback_success`)

**位置**: `backend/dvadmin/agent_manager/pay_plugins/alipay_plugin.py:306-402`

**触发时机**: 订单支付成功后

**主要逻辑**:

#### 2.5.1 成功金额统计

```python
# 根据模式统计成功金额
if tenant_id != product.writeoff.parent_id:  # 神码模式
    success_base_day_statistics(AlipayShenmaDayStatistics, 
                                success_money=money, tax=0, ...)
else:  # 普通模式
    success_base_day_statistics(AlipayProductDayStatistics, 
                                success_money=money, tax=0, ...)

# 公池模式统计
pool = AlipayPublicPool.objects.filter(alipay_id=product_id).first()
if pool:
    success_base_day_statistics(AlipayPublicPoolDayStatistics, 
                                success_money=money, tax=0, ...)
```

**统计内容**:

- 增加 `success_count`（成功次数）
- 增加 `success_money`（成功金额）

#### 2.5.2 分账处理

根据 `collection_type` 进行不同的分账处理：

**分账模式 (collection_type == 0)**:

```python
# 扣除支付宝手续费: 0.6%
money = money - max(int(money * 0.006), 1)
# 启动分账
start_group_split(amount, tenant_id, product_id, product, order_no, ...)
```

**智能出款 (collection_type == 3)**:

```python
# 扣除支付宝手续费
money = money - max(int(money * 0.006), 1)
# 按比例分账
percentage = Decimal(int(cache.get(f"{product.id}_alipay_max_ratio")))
amount = int(money * percentage / 100)
# 分账
start_group_split(amount, ...)
# 剩余金额转账给随机用户
amount = money - amount
if amount > 0:
    transfer_user = get_rand_transfer_user(money, tenant_id, product_id)
    # 创建转账记录
```

**自动转账 (collection_type == 1)**:

```python
# 扣除支付宝手续费
amount = money - max(int(money * 0.006), 1)
# 全部转账
start_group_split(amount, ..., split_percent=Decimal(100), split_type=1)
```

**支付宝手续费计算公式**:

```
支付宝手续费 = max(int(订单金额 * 0.006), 1)
```

- 固定费率: 0.6%
- 最低扣除: 1分

---

### 2.6 订单成功通知 (`success_notify`)

**位置**: `backend/dvadmin/agent_manager/utils/notify.py:133-144`

**触发时机**: 收到支付宝支付成功通知后

**流程**:

```python
def success_notify(order_no, ticket_no, pay_time, plugin_type, data):
    # 1. 更新订单详情
    OrderDetail.objects.filter(order__order_no=order_no).update(ticket_no=ticket_no)
    
    # 2. 验证通知内容
    if responder.check_notify_success(data):
        # 3. 处理订单成功
        success_order(order_no, notify_time, pay_time)
```

---

### 2.7 订单成功处理 (`success_order`)

**位置**: `backend/dvadmin/agent_manager/utils/notify.py:108-123`

**流程**:

```python
def success_order(order_no, notify_time, pay_time):
    # 1. 更新订单状态为 SUCCESS_PRE_STATUS (4)
    order_obj.order_status = Order.SUCCESS_PRE_STATUS
    order_obj.pay_datetime = pay_time
    order_obj.save()
    
    # 2. 构建回调参数
    create_data = create_create_args(order_obj, order_before)
    
    # 3. 触发成功通知钩子
    notify_order_success(**create_data)
```

**回调参数包含**:

- `order_no`: 订单号
- `out_order_no`: 商户订单号
- `tax`: 租户手续费
- `merchant_tax`: 商户手续费
- `money`: 订单金额
- `notify_money`: 通知金额
- `real_money`: 实际收入 = notify_money - merchant_tax
- `tenant_id`: 租户ID
- `merchant_id`: 商户ID
- `writeoff_id`: 核销ID
- `channel_id`: 通道ID
- 等等...

---

### 2.8 统计数据回调函数

**位置**: `backend/dvadmin/agent_manager/views/data_analysis.py`

通过 `@order_success_handle()` 装饰器注册的回调函数：

#### 2.8.1 通道统计 (`callback_pay_channel_success`)

```python
@order_success_handle()
def callback_pay_channel_success(channel_id, notify_money, real_money, tax, 
                                 tenant_id, merchant_id, writeoff_id, 
                                 create_datetime, **kwargs):
    success_base_day_statistics(
        PayChannelDayStatistics, 
        success_money=notify_money, 
        tax=tax,
        update_kwargs={"real_money": real_money},
        tenant_id=tenant_id, 
        merchant_id=merchant_id, 
        writeoff_id=writeoff_id,
        pay_channel_id=channel_id, 
        date=date.today()
    )
```

**统计内容**:

- `success_count`: 成功次数 +1
- `success_money`: 成功金额 +notify_money
- `total_tax`: 总手续费 +tax
- `real_money`: 实际收入 +real_money

#### 2.8.2 商户统计 (`callback_merchant_success`)

```python
@order_success_handle()
def callback_merchant_success(merchant_id, notify_money, real_money, tax, 
                              create_datetime, **kwargs):
    success_base_day_statistics(
        MerchantDayStatistics, 
        success_money=notify_money, 
        tax=tax,
        update_kwargs={"real_money": real_money},
        merchant_id=merchant_id, 
        date=date.today()
    )
    # 更新商户预付款
    update_merchant_pre(-real_money, merchant_id)
```

**统计内容**:

- `success_count`: 成功次数 +1
- `success_money`: 成功金额 +notify_money
- `total_tax`: 总手续费 +tax
- `real_money`: 实际收入 +real_money

#### 2.8.3 租户统计 (`callback_tenant_success`)

```python
@order_success_handle()
def callback_tenant_success(tenant_id, notify_money, tax, create_datetime, **kwargs):
    success_base_day_statistics(
        TenantDayStatistics, 
        success_money=notify_money, 
        tax=tax,
        tenant_id=tenant_id, 
        date=date.today()
    )
```

**统计内容**:

- `success_count`: 成功次数 +1
- `success_money`: 成功金额 +notify_money
- `total_tax`: 总手续费 +tax

#### 2.8.4 核销统计 (`callback_writeoff_success`)

```python
@order_success_handle()
def callback_writeoff_success(writeoff_id, money, tax, create_datetime, **kwargs):
    success_base_day_statistics(
        WriteOffDayStatistics, 
        success_money=money, 
        tax=tax,
        writeoff_id=writeoff_id, 
        date=date.today()
    )
    # 更新核销预付款
    update_writeoff_pre(-money, writeoff_id)
```

**统计内容**:

- `success_count`: 成功次数 +1
- `success_money`: 成功金额 +money
- `total_tax`: 总手续费 +tax

#### 2.8.5 全局日统计 (`callback_day_success`)

```python
@order_success_handle()
def callback_day_success(notify_money, tax, create_datetime, **kwargs):
    success_base_day_statistics(
        DayStatistics, 
        success_money=notify_money, 
        tax=tax,
        date=date.today()
    )
```

**统计内容**:

- `success_count`: 成功次数 +1
- `success_money`: 成功金额 +notify_money
- `total_tax`: 总手续费 +tax（系统总利润）

---

### 2.9 租户扣费 (`tenant_success_tax`)

**位置**: `backend/dvadmin/agent_manager/utils/update_task.py:17-47`

**触发时机**: 通过 `callback_tenant_tax_success` 回调

**位置**: `backend/dvadmin/agent_manager/views/tenant.py:55-60`

```python
@order_success_handle()
def callback_tenant_tax_success(tenant_id, tax, order_id, channel_id, reorder, 
                                order_before, **kwargs):
    if order_before != 7:
        # 删除预扣
        take_up_tax(tenant_id, -tax)
    # 扣除手续费
    tenant_success_tax(tenant_id, tax, order_id, channel_id, reorder)
```

**扣费逻辑**:

```python
def tenant_success_tax(tenant_id, tax, order_id, channel_id, reorder, remarks="手续费"):
    tenant = Tenant.objects.filter(id=tenant_id).first()
    if tenant and tax != 0:
        before = tenant.balance
        tenant.balance -= tax  # 扣除手续费
        tenant.save()
        # 记录流水
        TenantCashFlow.objects.create(
            tenant_id=tenant_id,
            old_money=before,
            new_money=tenant.balance,
            change_money=-tax,  # 负数表示扣费
            flow_type=1,  # 1=消费
            remarks=remarks,
            order_id=order_id,
            pay_channel_id=channel_id
        )
```

**扣费公式**:

```
租户余额 = 租户余额 - 租户手续费
```

---

## 三、费用计算公式总结

### 3.1 手续费计算公式

#### 租户手续费

```
租户手续费 = max(int(通道费率 * 订单金额(浮动后) / 100 + 0.5), 1)
```

- **数据来源**: `PayChannelTax.tax`
- **计算时机**: 订单创建时（浮动金额应用后）
- **最低扣除**: 1分
- **扣费时机**: 订单成功后

#### 商户手续费

```
商户手续费 = int(商户费率 * 订单金额(浮动前) / 100)
```

- **数据来源**: `MerchantPayChannel.tax`
- **计算时机**: 订单创建时（浮动金额应用前）
- **最低扣除**: 无
- **扣费方式**: 从实际收入中扣除

#### 支付宝手续费

```
支付宝手续费 = max(int(订单金额 * 0.006), 1)
```

- **费率**: 固定 0.6%
- **计算时机**: 订单成功分账时
- **最低扣除**: 1分
- **扣费方式**: 从分账金额中扣除

### 3.2 实际收入计算

```
实际收入 = 通知金额 - 商户手续费
```

### 3.3 分账金额计算

#### 分账模式 (collection_type == 0)

```
分账金额 = 订单金额 - 支付宝手续费
```

#### 智能出款 (collection_type == 3)

```
分账金额 = (订单金额 - 支付宝手续费) * 分账比例 / 100
剩余转账金额 = (订单金额 - 支付宝手续费) - 分账金额
```

#### 自动转账 (collection_type == 1)

```
转账金额 = 订单金额 - 支付宝手续费
```

---

## 四、统计数据模型

### 4.1 统计模型列表

1. **AlipayProductDayStatistics** - 支付宝产品日统计
   - `product_id`: 产品ID
   - `submit_count`: 提交次数
   - `submit_money`: 提交金额
   - `success_count`: 成功次数
   - `success_money`: 成功金额

2. **AlipayShenmaDayStatistics** - 神码日统计
   - `shenma_id`: 神码ID
   - 同上

3. **AlipayPublicPoolDayStatistics** - 公池日统计
   - `pool_id`: 公池ID
   - 同上

4. **PayChannelDayStatistics** - 通道日统计
   - `pay_channel_id`: 通道ID
   - `tenant_id`: 租户ID
   - `merchant_id`: 商户ID
   - `writeoff_id`: 核销ID
   - `success_count`: 成功次数
   - `success_money`: 成功金额
   - `total_tax`: 总手续费
   - `real_money`: 实际收入

5. **MerchantDayStatistics** - 商户日统计
   - `merchant_id`: 商户ID
   - `success_count`: 成功次数
   - `success_money`: 成功金额
   - `total_tax`: 总手续费（商户手续费）
   - `real_money`: 实际收入

6. **TenantDayStatistics** - 租户日统计
   - `tenant_id`: 租户ID
   - `success_count`: 成功次数
   - `success_money`: 成功金额
   - `total_tax`: 总手续费（租户手续费）

7. **WriteOffDayStatistics** - 核销日统计
   - `writeoff_id`: 核销ID
   - `success_count`: 成功次数
   - `success_money`: 成功金额
   - `total_tax`: 总手续费

8. **DayStatistics** - 全局日统计
   - `success_count`: 成功次数
   - `success_money`: 成功金额
   - `total_tax`: 总手续费（系统总利润）

---

## 五、关键代码位置

### 5.1 订单创建

- `backend/dvadmin/agent_manager/views/order.py` - `OrderViewSet.create()`
- `backend/dvadmin/agent_manager/utils/order/handle.py` - 订单检查逻辑

### 5.2 产品选择

- `backend/dvadmin/agent_manager/pay_plugins/alipay_plugin.py` - `get_writeoff_product()`

### 5.3 支付URL生成

- `backend/dvadmin/agent_manager/pay_plugins/alipay_plugin.py` - `create_order()`

### 5.4 回调处理

- `backend/dvadmin/agent_manager/pay_plugins/alipay_plugin.py` - `callback_submit()`, `callback_success()`

### 5.5 订单成功处理

- `backend/dvadmin/agent_manager/utils/notify.py` - `success_notify()`, `success_order()`
- `backend/dvadmin/agent_manager/utils/notify_hook.py` - `notify_order_success()`

### 5.6 统计数据

- `backend/dvadmin/agent_manager/views/data_analysis.py` - 各种统计回调函数
- `backend/dvadmin/agent_manager/utils/util.py` - `success_base_day_statistics()`

### 5.7 租户扣费

- `backend/dvadmin/agent_manager/utils/update_task.py` - `tenant_success_tax()`
- `backend/dvadmin/agent_manager/views/tenant.py` - `callback_tenant_tax_success()`

---

## 六、流程图

```
订单创建
  ↓
验证参数（商户、租户、签名）
  ↓
检查通道配置
  ↓
计算手续费（租户手续费、商户手续费）
  ↓
选择支付宝产品
  ↓
生成支付URL
  ↓
callback_submit() - 记录提交统计
  ↓
用户支付
  ↓
支付宝回调
  ↓
success_notify() - 验证通知
  ↓
success_order() - 更新订单状态
  ↓
notify_order_success() - 触发回调钩子
  ↓
callback_success() - 产品成功回调（分账处理）
  ↓
callback_pay_channel_success() - 通道统计
  ↓
callback_merchant_success() - 商户统计
  ↓
callback_tenant_success() - 租户统计
  ↓
callback_tenant_tax_success() - 租户扣费
  ↓
callback_writeoff_success() - 核销统计
  ↓
callback_day_success() - 全局统计
```

---

## 七、注意事项

1. **手续费计算时机**:
   - 租户手续费：在订单创建时计算（浮动后金额）
   - 商户手续费：在订单创建时计算（浮动前金额）
   - 支付宝手续费：在订单成功分账时计算

2. **扣费时机**:
   - 租户手续费：订单成功后立即扣除
   - 商户手续费：从实际收入中扣除（不直接扣余额）

3. **统计更新**:
   - 所有统计数据都是累加的
   - 使用 `success_base_day_statistics()` 统一更新
   - 按日期、维度（产品/通道/商户/租户等）分别统计

4. **分账模式**:
   - 分账前会先扣除支付宝手续费（0.6%）
   - 不同 `collection_type` 有不同的分账逻辑

5. **预扣机制**:
   - 租户手续费在订单创建时可能进行预扣（`take_up_tax`）
   - 订单成功后删除预扣并实际扣费
